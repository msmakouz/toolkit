!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@spiral-toolkit/core")):"function"==typeof define&&define.amd?define("@spiral-toolkit/form",["@spiral-toolkit/core"],t):"object"==typeof exports?exports["@spiral-toolkit/form"]=t(require("@spiral-toolkit/core")):e["@spiral-toolkit/form"]=t(e["@spiral-toolkit/core"])}(window,(function(__WEBPACK_EXTERNAL_MODULE__1__){return function(e){var t={};function s(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,o){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(s.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(o,r,function(t){return e[t]}.bind(null,r));return o},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s(s.s=4)}([function(e,t,s){const o=s(1),r={template:'<div class="alert alert-${type} alert-dismissible fade show" role="alert">${text}<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>',close:".close",place:"bottom",levels:{success:"success",info:"info",warning:"warning",error:"danger"},selector:"[data-message]",field:"[data-field]",fieldElement:"[data-input]",fieldTemplate:'<div data-message class="invalid-feedback" data-form-message>${text}</div>',fieldPlace:"bottom",fieldClasses:{success:"is-valid",info:"is-valid",warning:"is-invalid",error:"is-invalid"}};function n(e,t){return"object"!=typeof e&&(e={text:e,type:t}),e.text=e.text||e.message||e,e.type=e.type||t,e}r.levels.message=r.levels.success,r.levels.debug=r.levels.success,r.levels.info=r.levels.notice=r.levels.info,r.levels.danger=r.levels.critical=r.levels.alert=r.levels.emergency=r.levels.error,e.exports={defaults:r,showMessages(e,t=!0){if(!e)return;let s=!1;const o=this;if(e.data&&(Object.keys(this.options.messages.levels).forEach(t=>{e.data[t]&&(this.showFormMessage(e.data[t],this.options.messages.levels[t]),s=!0)}),e.data.messages&&(this.showFieldsMessages(e.data.messages,"success",t),s=!0),e.data.errors&&(this.showFieldsMessages(e.data.errors,"error",t),s=!0),e.data.warnings&&(this.showFieldsMessages(e.data.warnings,"warning",t),s=!0)),!s){let t;e.status?e.status>300&&(t=e.status?`${e.status} `:"",t+=e.statusText?e.statusText:"",t+=e.data&&!e.statusText?e.data:""):t=e,t&&this.showFormMessage(t,this.options.messages.levels.error)}this._messages.forEach(e=>{e.close&&(e.closeHandler=o.removeMessage.bind(o,e),e.close.addEventListener("click",e.closeHandler))})},removeMessage(e,t){if(e.close&&e.close.removeEventListener("click",e.closeHandler),e.el.parentNode.removeChild(e.el),e.field){const t=e.field.querySelector(this.options.messages.fieldElement);t?t.classList.remove(this.options.messages.fieldClasses[e.type]):e.field.classList.remove(this.options.messages.fieldClasses[e.type])}t&&(t.preventDefault&&t.preventDefault(),this._messages.splice(this._messages.indexOf(e),1))},removeMessages(){const e=this;this._messages&&this._messages.forEach(t=>{e.removeMessage(t,!1)}),e._messages=[]},showFormMessage(e,t){let s,o=this.options.messages.template;e=n(e,t),Object.keys(e).forEach(t=>{e.hasOwnProperty(t)&&(o=o.replace(`\${${t}}`,e[t]))});const r=document.createElement("div");r.innerHTML=o;const a=r.firstChild;"bottom"===this.options.messages.place?this.node.appendChild(a):"top"===this.options.messages.place?this.node.insertBefore(a,this.node.firstChild):(s=document.querySelector(this.options.messages.place),s.appendChild(a)),this._messages.push({el:a,close:a.querySelector(this.options.messages.close)})},showFieldMessage(e,t,s,r){let a=r?e:o.helpers.domTools.closest(e,this.options.messages.field),i=this.options.messages.fieldTemplate;if(!a)return;t=n(t,s);const l=a.querySelector(this.options.messages.fieldElement),c=a.querySelector(this.options.messages.selector);l?l.classList.add(this.options.messages.fieldClasses[s]):a.classList.add(this.options.messages.fieldClasses[s]),Object.keys(t).forEach(e=>{t.hasOwnProperty(e)&&(i=i.replace(`\${${e}}`,t[e]))});const p=document.createElement("div");p.innerHTML=i;const u=p.firstChild;"bottom"===this.options.messages.fieldPlace?l?a.insertBefore(u,l.nextSibling):c||a.appendChild(u):"top"===this.options.messages.fieldPlace?a.insertBefore(u,a.firstChild):(a=a.querySelector(this.options.messages.fieldPlace),a.appendChild(u)),this._messages.push({el:u,close:u.querySelector(this.options.messages.fieldClose),field:a,type:s})},showFieldsMessages(e,t,s=!0){const r=this,n=o.iterateInputs(this.node,e,(e,s)=>{r.showFieldMessage(e,s,t)});s&&n.forEach(e=>{Object.keys(e).forEach(s=>{const o=r.node.querySelector(`[data-message-placeholder="${s}"]`);o&&r.showFieldMessage(o,e[s],t,!0)})})}}},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE__1__},function(e,t){const s=function(e){return!!e&&(this.formRef=e,this.keyRegex=/[^\[\]]+/g,this.$form=null,this.$formElements=[],this.formObj={},!!this.setForm()&&(!!this.setFormElements()&&this.setFormObj()))};s.prototype.setForm=function(){switch(typeof this.formRef){case"string":this.$form=document.getElementById(this.formRef);break;case"object":this.isDomNode(this.formRef)&&(this.$form=this.formRef)}return this.$form},s.prototype.setFormElements=function(){return this.$formElements=this.$form.querySelectorAll("input, textarea, select"),this.$formElements.length},s.prototype.isDomNode=function(e){return"object"==typeof e&&"nodeType"in e&&1===e.nodeType},s.prototype.forEach=function(e,t){[].forEach?[].forEach.call(e,t):Object.keys(e).forEach(s=>{Object.prototype.hasOwnProperty.call(e,s)&&t.call(e,e[s])})},s.prototype.addChild=function(e,t,s,o){if(1===s.length){if("INPUT"===t.nodeName&&"radio"===t.type)return t.checked?void(e[s]=o):void 0;if("INPUT"===t.nodeName&&"checkbox"===t.type)return void(o?t.checked&&(e[s]||(e[s]=[]),e[s].push(o)):e[s]=t.checked?1:0);if("SELECT"===t.nodeName){if("select-multiple"===t.type){e[s]=[];const o=t.querySelectorAll("option[selected]");o&&this.forEach(o,t=>{e[s].push(t.value)})}else e[s]=o;return}e[s]=o}s.length>1&&(e[s[0]]||(e[s[0]]={}),this.addChild(e[s[0]],t,s.splice(1,s.length),o))},s.prototype.setFormObj=function(){let e,t=0;for(t=0;t<this.$formElements.length;t+=1)this.$formElements[t].name&&!this.$formElements[t].disabled&&(e=this.$formElements[t].name.match(this.keyRegex),this.addChild(this.formObj,this.$formElements[t],e,this.$formElements[t].value));return this.formObj},e.exports=s},function(e,t){let s=[];e.exports=function(e,t,o,r){return s=[],function e(t,o,r,n){Object.keys(o).forEach(a=>{if(!o.hasOwnProperty(a))return;const i=n?`${n}[${a}]`:a,l=Object.prototype.toString.call(o[a]),c=`[name='${i}']`;switch(l){case"[object Object]":e(t,o[a],r,i);break;case"[object Array]":o[a].forEach(e=>{const o=`[name='${i}[]'][value='${e}']`,n=t.querySelectorAll(o);0===n.length&&s.push(o);for(let e=0,t=n.length;e<t;e+=1)r(n[e],!0)});break;case"[object String]":case"[object Number]":const n=t.querySelectorAll(c);if(0===n.length){const e={};e[i]=o[a],s.push(e)}for(let e=0,t=n.length;e<t;e+=1)r(n[e],o[a]);break;default:console.error("unknown type -",l," and message",o[a])}})}(e,t,o,r),s.length,s}},function(e,t,s){e.exports=s(5)},function(e,t,s){const o=s(1),r=s(6).default;o.registerInstanceType(r,"js-sf-form"),e.exports=r},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0__),_formToObject__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),_formToObject__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_formToObject__WEBPACK_IMPORTED_MODULE_1__),_formMessages__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(0),_formMessages__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_formMessages__WEBPACK_IMPORTED_MODULE_2__),_iterateInputs__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(3),_iterateInputs__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_iterateInputs__WEBPACK_IMPORTED_MODULE_3__),_styles_css__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(7),_styles_css__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_styles_css__WEBPACK_IMPORTED_MODULE_4__);let idCounter=1;const Form=function(e,t,s){this._construct(e,t,s)};Form.prototype=_spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0___default.a.createModulePrototype(),Form.prototype.name="form",Form.prototype._construct=function(e,t,s){this.init(e,t,s),this.options.jsonOnly=this.options.jsonOnly&&!!window.FormData,this.mixMessagesOptions(),this.DOMEvents=new this.sf.helpers.DOMEvents,this.addEvents(),this.events=new this.sf.core.Events(["beforeSend","success","error","always"]),_spiral_toolkit_core__WEBPACK_IMPORTED_MODULE_0___default.a.iterateInputs=_iterateInputs__WEBPACK_IMPORTED_MODULE_3___default.a},Form.prototype.optionsToGrab={context:{processor:e=>e},self:{processor(){return this}},id:{value:`form:${idCounter++}`,domAttr:"id"},url:{domAttr:"action",value:"/"},method:{domAttr:"method",value:"POST"},lockType:{value:"default",domAttr:"data-lock-type"},jsonOnly:{value:!1,domAttr:"data-json-only"},messagesType:{value:"spiral",domAttr:"data-messages-type"},messages:{value:"",domAttr:"data-messages",processor(e,t,s){if(!t)return this.value;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){console.error("Form JSON.parse error: ",e)}return Object.assign(s.value,t)}},useAjax:{value:!0,domAttr:"data-use-ajax",processor:(e,t)=>("boolean"==typeof t||("false"===(t=null!=t?t.toLowerCase():"")?t=!1:"true"===t&&(t=!0)),t)},ajaxCallback:{value:!1,domAttr:"data-callback"},beforeSubmitCallback:{value:!1,domAttr:"data-before-submit"},afterSubmitCallback:{value:!1,domAttr:"data-after-submit"},headers:{value:{Accept:"application/json"},domAttr:"data-headers",processor(e,t,s){if(void 0===t||null==t)return this.value;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){console.error("Form JSON.parse error: ",e)}return Object.assign(s.value,t)}}},Form.prototype.mixMessagesOptions=function(){const e=this.sf.options.instances.form;this.options.messages={..._formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.defaults,...e&&e.messages&&e.messages[this.options.messagesType],...this.options.messages}},Form.prototype.onSubmit=function(e){if(this.sf.getInstance("lock",this.node))return e.preventDefault(),void e.stopPropagation();this.removeMessages(),this.options.data=this.getFormData(),this.options.jsonOnly||0===this.options.context.querySelectorAll("input[type='file']").length||(this.options.useAjax=!1),this.events.trigger("beforeSend",this.options),this.options.useAjax&&(this.send(this.options),e.preventDefault(),e.stopPropagation())},Form.prototype.lock=function(){if(!this.options.lockType||"none"===this.options.lockType)return;const e=this.sf.addInstance("lock",this.node,{type:this.options.lockType});e?this.options.onProgress=e.progress:console.warn("You try to add 'lock' instance, but it is not available or already started")},Form.prototype.unlock=function(){this.options.lockType&&"none"!==this.options.lockType&&(this.sf.removeInstance("lock",this.node)||console.warn("You try to remove 'lock' instance, but it is not available or not started"))},Form.prototype.showFormMessage=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.showFormMessage,Form.prototype.showFieldMessage=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.showFieldMessage,Form.prototype.showFieldsMessages=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.showFieldsMessages,Form.prototype.showMessages=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.showMessages,Form.prototype.removeMessages=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.removeMessages,Form.prototype.removeMessage=_formMessages__WEBPACK_IMPORTED_MODULE_2___default.a.removeMessage,Form.prototype.processAnswer=function(e,t=!0){this.options.messagesType&&this.showMessages(e,t)},Form.prototype.setFieldValues=function(e){this.sf.iterateInputs(this.node,e,(e,t)=>{"function"==typeof e.sfSetValue?e.sfSetValue(t):("checkbox"===e.type&&(e.value?e.checked=Array.isArray(t)?t.indexOf(e.value)>=0:e.value==t:e.checked=!!t),e.value=t)})},Form.prototype.enumerateFieldNames=function(){return console.log(this.node.querySelectorAll("input,select,textarea")),[...this.node.querySelectorAll("input,select,textarea")].map(e=>e.getAttribute("name"))},Form.prototype.optCallback=function(options,type){if(options[type]){const fn=eval(options[type]);if("function"==typeof fn)return fn.call(this,options)}},Form.prototype.send=function(e){const t=this;!1!==this.optCallback(e,"beforeSubmitCallback")&&(this.lock(),this.sf.ajax.send(e).then(s=>(t.events.trigger("success",e),s),s=>(t.events.trigger("error",e),s)).then(s=>{t.lock(!0),t.processAnswer(s),this.optCallback(e,"afterSubmitCallback"),t.events.trigger("always",e)}))},Form.prototype.getFormData=function(){return this.options.jsonOnly?new _formToObject__WEBPACK_IMPORTED_MODULE_1___default.a(this.options.context):new FormData(this.options.context)},Form.prototype.setOptions=function(e){this.options=Object.assign(this.options,e)},Form.prototype.addEvents=function(){const e=this;this.DOMEvents.add([{DOMNode:this.options.context,eventType:"submit",eventFunction(t){e.onSubmit.call(e,t)}}])},Form.prototype.die=function(){this.DOMEvents.removeAll()},__webpack_exports__.default=Form},function(e,t,s){var o=s(8),r=s(9);"string"==typeof(r=r.__esModule?r.default:r)&&(r=[[e.i,r,""]]);var n={insert:"head",singleton:!1},a=(o(r,n),r.locals?r.locals:{});e.exports=a},function(e,t,s){"use strict";var o,r=function(){return void 0===o&&(o=Boolean(window&&document&&document.all&&!window.atob)),o},n=function(){var e={};return function(t){if(void 0===e[t]){var s=document.querySelector(t);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(e){s=null}e[t]=s}return e[t]}}(),a=[];function i(e){for(var t=-1,s=0;s<a.length;s++)if(a[s].identifier===e){t=s;break}return t}function l(e,t){for(var s={},o=[],r=0;r<e.length;r++){var n=e[r],l=t.base?n[0]+t.base:n[0],c=s[l]||0,p="".concat(l," ").concat(c);s[l]=c+1;var u=i(p),_={css:n[1],media:n[2],sourceMap:n[3]};-1!==u?(a[u].references++,a[u].updater(_)):a.push({identifier:p,updater:h(_,t),references:1}),o.push(p)}return o}function c(e){var t=document.createElement("style"),o=e.attributes||{};if(void 0===o.nonce){var r=s.nc;r&&(o.nonce=r)}if(Object.keys(o).forEach((function(e){t.setAttribute(e,o[e])})),"function"==typeof e.insert)e.insert(t);else{var a=n(e.insert||"head");if(!a)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");a.appendChild(t)}return t}var p,u=(p=[],function(e,t){return p[e]=t,p.filter(Boolean).join("\n")});function _(e,t,s,o){var r=s?"":o.media?"@media ".concat(o.media," {").concat(o.css,"}"):o.css;if(e.styleSheet)e.styleSheet.cssText=u(t,r);else{var n=document.createTextNode(r),a=e.childNodes;a[t]&&e.removeChild(a[t]),a.length?e.insertBefore(n,a[t]):e.appendChild(n)}}function f(e,t,s){var o=s.css,r=s.media,n=s.sourceMap;if(r?e.setAttribute("media",r):e.removeAttribute("media"),n&&btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(n))))," */")),e.styleSheet)e.styleSheet.cssText=o;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(o))}}var d=null,m=0;function h(e,t){var s,o,r;if(t.singleton){var n=m++;s=d||(d=c(t)),o=_.bind(null,s,n,!1),r=_.bind(null,s,n,!0)}else s=c(t),o=f.bind(null,s,t),r=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(s)};return o(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;o(e=t)}else r()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=r());var s=l(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var o=0;o<s.length;o++){var r=i(s[o]);a[r].references--}for(var n=l(e,t),c=0;c<s.length;c++){var p=i(s[c]);0===a[p].references&&(a[p].updater(),a.splice(p,1))}s=n}}}},function(e,t,s){(t=s(10)(!0)).push([e.i,"[data-form-message] ~ [data-form-hint] {\n  display: none;\n}\n\n.is-invalid[data-message-placeholder]>.invalid-feedback,\n.is-invalid[data-field]>.invalid-feedback {\n  display: block;\n}\n","",{version:3,sources:["styles.css"],names:[],mappings:"AAAA;EACE,aAAa;AACf;;AAEA;;EAEE,cAAc;AAChB",file:"styles.css",sourcesContent:["[data-form-message] ~ [data-form-hint] {\n  display: none;\n}\n\n.is-invalid[data-message-placeholder]>.invalid-feedback,\n.is-invalid[data-field]>.invalid-feedback {\n  display: block;\n}\n"]}]),e.exports=t},function(e,t,s){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var s=function(e,t){var s=e[1]||"",o=e[3];if(!o)return s;if(t&&"function"==typeof btoa){var r=(a=o,i=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(i),"/*# ".concat(l," */")),n=o.sources.map((function(e){return"/*# sourceURL=".concat(o.sourceRoot||"").concat(e," */")}));return[s].concat(n).concat([r]).join("\n")}var a,i,l;return[s].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(s,"}"):s})).join("")},t.i=function(e,s,o){"string"==typeof e&&(e=[[null,e,""]]);var r={};if(o)for(var n=0;n<this.length;n++){var a=this[n][0];null!=a&&(r[a]=!0)}for(var i=0;i<e.length;i++){var l=[].concat(e[i]);o&&r[l[0]]||(s&&(l[2]?l[2]="".concat(s," and ").concat(l[2]):l[2]=s),t.push(l))}},t}}])}));
//# sourceMappingURL=form.js.map